---
title: "Rails + Dynamoid(DynamoDB) ã§ã€å­˜åœ¨ã—ãªã„ Primary Key ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã®å›é¿æ–¹æ³•"
emoji: "ğŸ°"
type: "tech"
topics:
  - "aws"
  - "ruby"
  - "rubyonrails"
  - "dynamodb"
  - "dynamoid"
published: true
published_at: "2023-12-27 13:49"
---

`Ruby on Rails` ã§ `DynamoDB` ã‚’ `ActiveRecord` ã®ã‚ˆã†ã«æ‰±ãˆã‚‹ `Dynamoid` ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
å­˜åœ¨ã—ãªã„ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã€`find` ãªã©ã‚’è¡Œã£ãŸå ´åˆã€`Dynamoid::Errors::RecordNotFound` ãŒç™ºç”Ÿã—ã¾ã™(ä»•æ§˜)ã€‚
ãã®å ´åˆã®å‡¦ç†æ–¹æ³•ã‚’å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¾ã™ã€‚

# è¦ç´„
- `begin-rescue` ã§ `Dynamoid::Errors::RecordNotFound` ã‚’æ‹¾ã†
- `raise_error option` ã‚’ false ã«è¨­å®šã™ã‚‹

# begin rescue ã§ `Dynamoid::Errors::RecordNotFound` ã‚’æ‹¾ã†

`Dynamoid::Errors::RecordNotFound` ã‚’ `begin-rescue` ã§æ‹¾ã„ã¾ã™ã€‚
`rescue` ã«å…¥ã£ãŸã¨ãã«ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãªã‚Šã§ã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªã„ã“ã¨ã‚’è¿”ã›ã°ã„ã„ã‚“ã˜ã‚ƒãªã„ã‹ãªã¨æ€ã„ã¾ã™ã€‚

:::details ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

```ruby
class SampleController < ActionController::Base
  def show
    meta = {
      exist: true
    }
    begin
      r = SampleTable.find("pk-1", range_key: "sk-1")
    rescue Dynamoid::Errors::RecordNotFound
      r = SampleTable.new
      meta[:exist] = false
    end
    # begin ã¨ end ã§ãã‚Œãã‚Œ render ã—ã¦ã‚‚ã„ã„ã‹ã‚‚
    render json: r,
           root: 'data',
           adapter: :json,
           meta: meta
  end
end
```

:::

# raise_error option ã« false ã‚’è¨­å®šã™ã‚‹
åˆ¥ã®æ–¹æ³•ã¨ã—ã¦ã€`find` ã‚’å®Ÿè¡Œã™ã‚‹éš›ã« `raise_error` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚
`raise_error` ã‚’ `false ã«è¨­å®šã™ã‚‹ã“ã¨ã§ã€`Dynamoid::Errors::RecordNotFound` ã®ç™ºç”Ÿã‚’æŠ‘åˆ¶ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ruby
r = SampleTable.find("pk-1", range_key: "sk-1", raise_error: false)
```

# ä»Šå¾Œè©¦ã—ãŸã„ã“ã¨
ã‚¨ãƒ©ãƒ¼ã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®šæ•°ã§ç´ã¥ã‘ã¦ç®¡ç†ã—ãŸã‚Šã€åŸºç›¤ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§ç®¡ç†ã—ãŸã‚Šã™ã‚‹æ–¹æ³•ã‚‚è©¦ã—ãŸã„ã€‚

https://tech.timee.co.jp/entry/2020/08/11/182724

# å‚è€ƒ
https://github.com/Dynamoid/dynamoid
https://www.rubydoc.info/gems/dynamoid/3.9.0
https://docs.ruby-lang.org/ja/latest/doc/spec=2fcontrol.html#begin
https://www.rubydoc.info/gems/dynamoid/Dynamoid%2FFinders%2FClassMethods:find