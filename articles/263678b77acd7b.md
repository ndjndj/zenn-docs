---
title: "ãƒ­ãƒ¼ã‚«ãƒ«ã§ build ã—ãŸ docker image ã‚’ ECR ã®ãƒªãƒã‚¸ãƒˆãƒªã« push ã™ã‚‹"
emoji: "ğŸ…°ï¸"
type: "tech"
topics:
  - "aws"
  - "docker"
  - "ecr"
published: true
published_at: "2024-01-31 16:00"
---

Amazon Lambda ã§ã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ãŸã‹ã£ãŸã®ã§ã™ãŒã€ãã®ãŸã‚ã«ã¯ã¾ãš Amazon ECR ã« Docker Image ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ã®ã“ã¨ã ã£ãŸã®ã§ã€ãã®æ‰‹é †ã«ã¤ã„ã¦å‚™å¿˜éŒ²ã‚’æ®‹ã—ã¾ã™ã€‚

ãªãŠã€ä½¿ç”¨ã—ã¦ã„ã‚‹ OS ã¯ Ubuntu 22.04 ã§ã™ã€‚

# æµã‚Œ
- AWS CLI ã®æº–å‚™
	- AWS CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
	- IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨­å®š
- ECR ã§ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆ
- Docker Image ã®ä½œæˆ
	- Dockerfile ã®ç”¨æ„
	- Docker Image ã®ãƒ“ãƒ«ãƒ‰
- ECR ã«ãƒ—ãƒƒã‚·ãƒ¥ãƒ»ç¢ºèª
	- ECR ã‹ã‚‰èªè¨¼ã‚’å¾—ã‚‹
	- ä½œæˆã—ãŸãƒªãƒã‚¸ãƒˆãƒªã¸ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹

# AWS CLI ã®æº–å‚™
å„è¨­å®šãŒçµ‚äº†ã—ã¦ã„ã‚‹å ´åˆã¯é£›ã°ã—ã¦ãã ã•ã„ã€‚
IAM ãƒ­ãƒ¼ãƒ«ã ã‘ç¢ºèªãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## ã“ã“ã§ã‚„ã‚‹ã“ã¨
- AWS CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- IAM ã®è¨­å®š

## AWS CLI 

ã¾ãšã€AWS CLI ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
ä½¿ç”¨ã™ã‚‹ OS ã«åˆã‚ã›ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚

https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/getting-started-install.html

## IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨­å®š
æ¬¡ã«ã€IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚
IAM Identity Center ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã“ã§ã¯ã€é€šå¸¸ã® IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚
ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ãƒãƒªã‚·ãƒ¼ã¯ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¦ã‚¢ã‚¿ãƒƒãƒã—ã¦ãã ã•ã„ã€‚

https://docs.aws.amazon.com/ja_jp/AmazonECR/latest/userguide/image-push.html

è‡ªåˆ†ã¯ã€èª­ã¿å–ã‚Šç³»ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚‚åŒæ™‚ã«å¾—ã‚‹ãŸã‚ã«ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¦ã€ã‚¢ã‚¿ãƒƒãƒã—ã¾ã—ãŸã€‚

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "ecr:GetDownloadUrlForLayer",
                "ecr:BatchGetImage",
                "ecr:CompleteLayerUpload",
                "ecr:GetAuthorizationToken",
                "ecr:UploadLayerPart",
                "ecr:InitiateLayerUpload",
                "ecr:BatchCheckLayerAvailability",
                "ecr:PutImage",
                "ecr:DescribeImages",
                "ecr:DescribePullThroughCacheRules",
                "ecr:ListImages"
            ],
            "Resource": "*"
        }
    ]
}
```

AWS CLI ã§ å…ˆã»ã©ä½œæˆã—ãŸ IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚

```bash
aws configure 
```

access key ID ã‚„ secret access key ãªã©ã®å…¥åŠ›ã‚’è¡Œã„ã¾ã™ã€‚

# ECR ã§ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆ
AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã€Elastic Container Registry(ECR) ã®ãƒšãƒ¼ã‚¸ã¾ã§ç§»å‹•ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/d054bb4d849f-20240131.png)

ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒšã‚¤ãƒ³ã‹ã‚‰ã€ŒPrivate registry/Repositoriesã€ã‚’é¸æŠã—ã€ã€Œãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã€ã‹ã‚‰ã€æ–°è¦ä½œæˆç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/0bb228bb76f6-20240131.png)

![](https://storage.googleapis.com/zenn-user-upload/bfc46ee84262-20240131.png)

ã€Œå¯è¦–æ€§è¨­å®šã€ã‚’ã€Œãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã€ã€ã€Œåå‰ã€ã‚’å…¥åŠ›ã—ã€æ–°ã—ã„ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚
åå‰ã¯å¾Œã»ã©ä½œæˆã™ã‚‹ Docker Image ã¨åŒã˜åå‰ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

# Docker Image ã®ä½œæˆ
ECR ã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ Docker Image ã‚’ä½œæˆã—ã¦ã„ãã¾ã™

## ã“ã“ã§ã‚„ã‚‹ã“ã¨
- Dockerfile ã®ç”¨æ„
- Docker Image ã®ãƒ“ãƒ«ãƒ‰

## Dockerfile ã®ç”¨æ„

ä½¿ç”¨ã™ã‚‹ Docker Image ã¯ã€[ã„ã¤ã‹ã®è¨˜äº‹](https://zenn.dev/ndjndj/articles/838f0a9268dccc)ã§ä½œæˆã—ãŸ Lambda Web Adapter ã‚’åˆ©ç”¨ã—ãŸã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ Meilisearch ç’°å¢ƒã®ã‚‚ã®ã‚’ä½¿ã„ã¾ã™ã€‚
æœ€çµ‚çš„ã«ã¯ã€Lambda ã§å‹•ä½œç¢ºèªã‚’ã—ãŸã„ã ã‘ãªã®ã§ã€æ‰‹å…ƒã« Lambda ç”¨ã®ã‚‚ã®ãŒã‚ã‚Œã°ãã‚Œã§ã‚‚ã‹ã¾ã„ã¾ã›ã‚“ã€‚

:::details Dockerfile
```Dockerfile
FROM gcr.io/distroless/cc-debian12:latest AS cc
FROM alpine:3.16

COPY --from=public.ecr.aws/awsguru/aws-lambda-adapter:0.7.0 /lambda-adapter /opt/extensions/lambda-adapter

# for execute meilisearch
ENV LD_LIBRARY_PATH="/usr/local/lib"
COPY --from=cc --chown=root:root --chmod=755 /lib/*-linux-gnu/* /usr/local/lib/

RUN apk update --quiet \
 && apk add -q --no-cache libgcc tini curl \
 && mkdir /lib64 \ 
 && ln -s /usr/local/lib/ld-linux-*.so.2 /lib64/

# Install Meilisearch
ARG version="v1.6.0"
ARG os="meilisearch-linux-amd64"
ARG url="https://github.com/meilisearch/meilisearch/releases/download"
RUN curl -OL ${url}/${version}/${os} | sh \
 && mv ${os} meilisearch \
 && chmod +x meilisearch \
 && mv meilisearch /usr/bin/

ENV MEILI_HTTP_ADDR 0.0.0.0:8080
ENV MEILI_SERVER_PROVIDER docker
ENV MEILI_DB_PATH /mnt/meili_data/data.ms
ENV MEILI_MASTER_KEY meilisearch-master-key 
ENV MEILI_ENV production

COPY ./meili_data /mnt/meili_data

# This directory should hold all the data related to meilisearch so we're going
# to move our PWD in there.
# We don't want to put the meilisearch binary
WORKDIR /mnt/meili_data

EXPOSE 8080/tcp

ENTRYPOINT ["tini", "--"]
CMD /usr/bin/meilisearch
```
:::

## Docker Image ã®ãƒ“ãƒ«ãƒ‰
Docker Image ã®ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã„ã¾ã™ã€‚
Docker Image ã®åå‰ã¯ã€å…ˆã»ã©ä½œæˆã—ãŸ ECR ã®ãƒªãƒã‚¸ãƒˆãƒªåã¨åŒã˜åå‰ã‚’ä»˜ã‘ã¾ã™ã€‚
```bash
docker build . -t <Docker Image ã®åå‰>:<ã‚¿ã‚°å> --no-cache
# ä¾‹) meilisearch-docker-lambda:latest 
```

ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ãŸã‚‰ã€ä½œæˆã—ãŸ Docker Image ã‚’ç¢ºèªã—ã¾ã™ã€‚
```bash
docker images 
# ã“ã‚“ãªæ„Ÿã˜ã§æŒ‡å®šã—ãŸã‚‚ã®ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã° OK
# REPOSITORY                 TAG    IMAGE ID    CREATED       SIZE
# meilisearch-docker-lambda  latest xxxxxxxxxxx n minutes ago x.xxGB
```

ç¶šã„ã¦ ECR ã§ä½œæˆã—ãŸãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã§ãã‚‹ã‚ˆã†ã«ã‚¿ã‚°ä»˜ã‘ã‚’è¡Œã„ã¾ã™ã€‚
ãƒªãƒ¼ã‚¸ãƒ§ãƒ³åã¨ Docker Image å(ãƒªãƒã‚¸ãƒˆãƒªå)ã¯é©å®œå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ID ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã®å³ä¸Šã‹ã‚‰ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/4e111fccd2ac-20240131.png)

```bash
docker tag <Docker Image å> <AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ID>.dkr.ecr.<ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å>.amazonaws.com/<Docker Image å>
```

ã‚‚ã—ãã¯ã€AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ« -> ECR -> ãƒªãƒã‚¸ãƒˆãƒª -> è©³ç´°ç”»é¢ã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ã®ç¢ºèªãŒå¯èƒ½ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/e58f05cfe932-20240131.png)

![](https://storage.googleapis.com/zenn-user-upload/df4a1bba875b-20240131.png)

# ECR ã«ãƒ—ãƒƒã‚·ãƒ¥ãƒ»ç¢ºèª
æœ€å¾Œã«ã€ä½œæˆã—ãŸãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã¸ãƒ—ãƒƒã‚·ãƒ¥ã‚’è¡Œã„ã¾ã™ã€‚

## ã“ã“ã§ã‚„ã‚‹ã“ã¨
- ECR ã‹ã‚‰èªè¨¼ã‚’å¾—ã‚‹
- ä½œæˆã—ãŸãƒªãƒã‚¸ãƒˆãƒªã¸ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹
- ç¢ºèªã™ã‚‹

## ECR ã‹ã‚‰èªè¨¼ã‚’å¾—ã‚‹
æ‰‹å…ƒã® Docker ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ ECR ã«å¯¾ã—ã¦èªè¨¼ã‚’å¾—ã¾ã™ã€‚
ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ã€ŒLogin Succeededã€ãŒè¡¨ç¤ºã•ã‚Œã‚Œã° OK ã§ã™ã€‚
å¾—ã‚‰ã‚ŒãŸèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã¯12æ™‚é–“æœ‰åŠ¹ãªãŸã‚ã€ãã‚Œä»¥é™ã¯ã‚‚ã†ä¸€åº¦ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦èªè¨¼ã‚’å¾—ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```bash
aws ecr get-login-password --region region | docker login --username AWS --password-stdin <AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ID>.dkr.ecr.<ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å>.amazonaws.com
```

## ä½œæˆã—ãŸãƒªãƒã‚¸ãƒˆãƒªã¸ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹
æœ€å¾Œã«ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã¸ãƒ—ãƒƒã‚·ãƒ¥ã‚’è¡Œã„ã¾ã™ã€‚

```
docker push <AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ID>.dkr.ecr.<ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å>.amazonaws.com/<Docker Image å>
```


## ç¢ºèªã™ã‚‹

AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«-> ECR -> ä½œæˆã—ãŸãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã€Docker Image ãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
ã¾ãŸã€AWS CLI ã‹ã‚‰ç¢ºèªã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

```bash
aws ecr describe-images --repository-name <ãƒªãƒã‚¸ãƒˆãƒªå>
```

ãƒ—ãƒƒã‚·ãƒ¥ã«æˆåŠŸã—ã¦ã„ã‚Œã°ã€å¯¾è±¡ã®ãƒªãƒã‚¸ãƒˆãƒªåã‚’å«ã‚“ã  json æ–‡å­—åˆ—ãŒè¿”ã£ã¦ãã¾ã™ã€‚
å¤±æ•—ã—ã¦ã„ã‚‹å ´åˆã¯ã€ã€ŒRepositoryNotFoundExceptionã€ãªã©ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã£ã¦ãã¾ã™ã€‚

# å‚è€ƒ
https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/getting-started-install.html
https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/getting-started-quickstart.html
https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/images-create.html
https://docs.aws.amazon.com/ja_jp/AmazonECR/latest/userguide/image-push.html
https://dev.classmethod.jp/articles/beginner-series-to-check-how-t-create-docker-image-and-push-to-amazon-ecr/
