---
title: "ã€Rails/Docker CEã€‘CMake ã‚’ Docker ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€Gem::Ext::BuildErrorã€‘"
emoji: "ğŸ¶"
type: "tech"
topics:
  - "docker"
  - "rails"
  - "ubuntu"
  - "cmake"
  - "gem"
published: true
published_at: "2023-12-20 14:00"
---

WSL docker CE(Ubuntu 22.04) ã§ Rails é–‹ç™ºç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚
ã‚ã‚‹ gem ã‚’ Gemfile ã«è¿½è¨˜ã—ã€`bundle install` ã‚’å®Ÿè¡Œã—ãŸã¨ã“ã‚ã€`Gem::Ext::BuildError: ERROR: Failed to build gem native extension.`ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å®Œäº†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
åŸå› ã®èª¿æŸ»ã¨å¯¾å¿œã‚’æ®‹ã—ã¦ãŠãã¾ã™ã€‚

# è©²å½“ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

```
$ bundle install
Fetching gem metadata from https://rubygems.org/.........
Resolving dependencies...

-----ä¸­ç•¥-----

Fetching h3 3.7.2ã€€<- è©²å½“ã® gem
Installing h3 3.7.2 with native extensions
Gem::Ext::BuildError: ERROR: Failed to build gem native
extension. 

-----ä¸­ç•¥-----

cd src; cmake . -DBUILD_SHARED_LIBS=true -DBUILD_FILTERS=OFF
-DBUILD_BENCHMARKS=OFF; make
/bin/sh: 1: cmake: not found
make[1]: Entering directory
'/usr/local/bundle/gems/h3-3.7.2/ext/h3/src'
make[1]: *** No targets specified and no makefile found.  Stop.
make[1]: Leaving directory
'/usr/local/bundle/gems/h3-3.7.2/ext/h3/src'
make: *** [Makefile:2: make] Error 2

make failed, exit code 2
```

# è¦ç´„
- è¿½åŠ ã—ã‚ˆã†ã¨ã—ãŸ gem ã¯ã€ãƒã‚¤ãƒ†ã‚£ãƒ–æ‹¡å¼µã‚’ç”¨ã„ã¦ C è¨€èªã‚„ C++ ãªã©ã§ä½œæˆã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã™ã‚‹ã‚‚ã®ã ã£ãŸ
- ä½œæˆã—ãŸç’°å¢ƒã«ã€ãã‚Œã‚‰ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãŸã‚ã® CMake ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã‹ã£ãŸ
- dockerfile ã« CMake ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½è¨˜ã—ã€å†ãƒ“ãƒ«ãƒ‰ã—ãŸã¨ã“ã‚ `bundle install` ã«æˆåŠŸã—ãŸ

# çµŒç·¯
1. h3 ã¨ã„ã†åœ°ç†ç©ºé–“ã‚’æ‰±ã†ãŸã‚ã® gem ã® install ã‚’è©¦ã¿ãŸ
2. `bundle install` ã«å¤±æ•—ã—ã€å†’é ­ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«é­é‡

# Gem::Ext::BuildError: ã¨ cmake not found
å†’é ­ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã€`Gem::Ext::BuildError: ERROR: Failed to build gem native extension. ` ã¨ `cmake: not found` ã¨ã„ã†éƒ¨åˆ†ã«ç€ç›®ã—ã¾ã—ãŸ
å‰åŠã§ã€ãƒã‚¤ãƒ†ã‚£ãƒ–æ‹¡å¼µã®ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ãŸã“ã¨ã¨ãã®ç†ç”±ãŒã€å¾ŒåŠã§ã€CMake ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ã“ã¨ã«ã‚ˆã‚‹ã‚‚ã®ã§ã‚ã‚‹ãŸã‚ã§ã‚ã‚‹ã¨é¡æ¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™

å®Ÿéš›ã«ã€`h3_ruby` ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ç¢ºèªã™ã‚‹ã¨ã€`README.md` ã‚’ç¢ºèªã™ã‚‹ã¨ Cè¨€èªã§æ§‹ç¯‰ã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã« ffi ã‚’ç”¨ã„ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹æ—¨ãŒè¨˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
>This gem uses FFI to link directly into the H3 library (written in C).

https://github.com/seanhandley/h3_ruby?tab=readme-ov-file#getting-started

# CMake ã‚’ install ã™ã‚‹
é–‹ç™ºç’°å¢ƒã« CMake ã‚’å°å…¥ã™ã‚‹ãŸã‚ã«ã€dockerfile ã«è¿½è¨˜ã‚’è¡Œã„ã¾ã—ãŸ
ã¾ãŸã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯[ã“ã¡ã‚‰](https://github.com/Kitware/CMake/releases)ã§ç¢ºèªã—ã¾ã—ãŸ

```dockerfile
RUN apt-get update && \
    apt-get -y install build-essential && \
    apt-get install -y wget && \
    wget https://github.com/Kitware/CMake/releases/download/v3.28.1/cmake-3.28.1-linux-x86_64.sh -q -O /tmp/cmake-install.sh && \
    chmod u+x /tmp/cmake-install.sh && \
    mkdir /opt/cmake-3.28.1 && \
    /tmp/cmake-install.sh --skip-license --prefix=/opt/cmake-3.28.1 && \
    rm /tmp/cmake-install.sh && \
    ln -s /opt/cmake-3.28.1/bin/* usr/local/bin
```

# å†ãƒ“ãƒ«ãƒ‰ã—ã¦ bundle install

```
$ docker compose build --no-cache
$ docker compose up -d
$ docker compose exec [ã‚³ãƒ³ãƒ†ãƒŠ] /bin/bash
$ bash: # bundle install
-> Bundle complete! xx Gemfile dependencies, xx gems now installed.
Use `bundle info [gemname]` to see where a bundled gem is installed.
```


# å‚è€ƒ
https://github.com/Kitware/CMake/releases
https://www.softwarepronto.com/2022/09/dockerubuntu-installing-latest-cmake-on.html