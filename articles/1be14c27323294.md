---
title: "ã€ç’°å¢ƒæ§‹ç¯‰ç·¨ã€‘Rails API Ã— Meilisearch SDK ã‚’ã¤ã‹ã£ã¦ã¿ã‚‹"
emoji: "ğŸ°"
type: "tech"
topics:
  - "docker"
  - "rails"
  - "meilisearch"
published: true
published_at: "2024-01-10 19:56"
---

`Rails` API ã‹ã‚‰ `Meilisearch` API ã‚’å‘¼ã³å‡ºã—ãŸã„ã®ã§ã€`Docker` ç’°å¢ƒã®æ§‹ç¯‰ã‚’è¡Œã„ã¾ã—ãŸã€‚

`Rails` ã¨ `Meilisearch` ã®é–‹ç™ºç’°å¢ƒã‚’ `Docker` ã§æ§‹ç¯‰ã—ã¾ã™ã€‚
æ§‹ç¯‰ã®éƒ¨åˆ†ã¯ä¸‹è¨˜ã®2è¨˜äº‹ã§ã»ã¨ã‚“ã©è£œå®Œã™ã‚‹ã“ã¨ãŒã§ãã¦ã€ç•°ãªã‚‹ã®ã¯ `compose.yml` ãã‚‰ã„ã§ã™ã€‚ãªã®ã§ã“ã®è¨˜äº‹ã§ã¯ã»ã¨ã‚“ã©æ‰‹é †ã‚’ã¾ã¨ã‚ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚
ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚„ã‚³ãƒãƒ³ãƒ‰ã®èª¬æ˜ã«ã¤ã„ã¦ã¯ã€ä¸‹è¨˜è¨˜äº‹ã‚‚ã—ãã¯ã€ä¸‹è¨˜è¨˜äº‹ã®å‚è€ƒæ–‡çŒ®ãŒã‚ˆã‚Šè©³ã—ã„ã§ã™ã€‚

https://zenn.dev/ndjndj/articles/c8b6359d2b42b0
https://zenn.dev/ndjndj/articles/ffcf6d9b535f86

# ã‚µãƒ³ãƒ—ãƒ«ãƒªãƒã‚¸ãƒˆãƒª

https://github.com/ndjndj/playground/tree/main/rails-meili-docker

# ç¶šç·¨

https://zenn.dev/ndjndj/articles/dc480aa28a7f39

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
å„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­ç½®ã•ã‚Œã¦ã„ã¾ã™ã€‚
`Meilisearch` ç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿(`sample.json`)ã ã‘ã¯ã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã« `meili` ç›´ä¸‹ã«ãŠã„ã¦ã„ã¾ã™ãŒã©ã“ã§ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚

```
.
â”œâ”€ compose.yml
â”œâ”€ meili
â”‚   â””â”€ sample.json
â””â”€ rails
    â”œâ”€ Gemfile
    â”œâ”€ Gemfile.lock
    â””â”€ entrypoint.sh
```

# ç’°å¢ƒè¨­å®š 

:::details compose.yml
```yml
version: '3'
services: 
  db: 
    container_name: postgres
    image: postgres:16.0
    ports: 
      - "5432:5432"
    volumes: 
      - pg-data:/var/lib/postgresql/data
    environment: 
      - POSTGRES_DATABASE=postgres 
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password 
      - POSTGRES_ROOT_PASSWORD=root
  meilisearch: 
    image: getmeili/meilisearch:v1.5 
    ports:
      - "7700:7700"
    environment: 
      - MEILI_MASTER_KEY=meili-master-key
    volumes: 
      - ./meili_data:/meili_data
  rails: 
    build: 
      context: ./rails
    command: bash -c "rails s -b '0.0.0.0'"
    volumes:
      - ./rails:/usr/src/app
    ports: 
      - 3000:3000
    depends_on:
      - db 
    tty: true 
    stdin_open: true
volumes: 
  pg-data:
  bin: 
    driver: local
```
:::

# æ§‹ç¯‰æ‰‹é †
å†’é ­ã«ã‚‚æ›¸ã„ãŸé€šã‚Šã€æ‰‹é †ã®ã¿æ›¸ã„ã¦ãŠãã¾ã™ã€‚

## rails ç’°å¢ƒæ§‹ç¯‰
```bash
# rails new 
docker compose run --rm rails rails new . --force --database=postgresql --api --skip-bundle
```

ã“ã“ã§ã„ã£ãŸã‚“ã€database.yml, Gemfile ã‚’æ›¸ãæ›ãˆã‚‹ã€‚

:::details config/databse.yml
```yml
default: &default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  username: postgres
  password: password 
  host: db
  port: 5432

development:
  <<: *default
  database: postgres_dev
  password: password

test:
  <<: *default
  database: postgres_test
  password: password
```
:::

:::details Gemfile
```
source "https://rubygems.org"
git_source(:github) {|repo| "https://github.com/#{repo}.git" }

ruby "3.3.0"

gem "bootsnap", require: false

gem "pg", "~> 1.1"

gem "puma", "~> 6.4.0"

gem "rails", "~> 7.1.2"

gem "tzinfo-data", platforms: %i[mingw mswin x64_mingw jruby]
```
:::

```bash
# bundle install
docker compose run --rm rails bundle install

# ã‚³ãƒ³ãƒ†ãƒŠç«‹ã¡ä¸Šã’
docker compose build --no-cache
docker compose up -d

# DB ä½œæˆ
docker compose exec api /bin/bash
rails db:create

# ç–é€šç¢ºèª
# localhost:3000 ã«ã‚¢ã‚¯ã‚»ã‚¹
```

## meilisearch ç’°å¢ƒæ§‹ç¯‰
```bash
# ç–é€šç¢ºèª
# rails ç’°å¢ƒæ§‹ç¯‰ã®éš›ã€docker up -d ã—ã¦ã„ã‚‹ãªã‚‰ã€meilisearch ã‚‚ç«‹ã¡ä¸ŠãŒã£ã¦ã„ã‚‹
# localhost:7700 ã«ã‚¢ã‚¯ã‚»ã‚¹
# å¿…è¦ã«å¿œã˜ã¦ APIkey ã‚’ã‚»ãƒƒãƒˆã—ã¦ãŠã

# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆã€sample.json ãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦ãŠã
curl \
  -X POST 'http://localhost:7700/indexes/{ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å}/documents?primaryKey={ä»»æ„ã®ã‚­ãƒ¼}' \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer meili-master-key' \
  --data-binary @sample.json
  
# ä½œæˆçŠ¶æ³ã®ç¢ºèª
curl \
  -X GET 'http://localhost:7700/tasks/0' \
  -H 'Authorization: Bearer meili-master-key'
  
# localhost:7700 ã«ã‚¢ã‚¯ã‚»ã‚¹/ç”»é¢æ›´æ–°
# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã€æ¤œç´¢ãŒã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
```

# ã•ã„ã”ã«
çµæ§‹ã‚ã£ã•ã‚Šã‚ã§ã™ãŒã€ä»Šå›ã¯ä»¥ä¸Šã§ã™ã€‚
å½“åˆã¯ç’°å¢ƒæ§‹ç¯‰ï¼‹SDK åˆ©ç”¨ã®è¨˜äº‹ã«ã—ã‚ˆã†ã¨è€ƒãˆã¦ã„ã¾ã—ãŸãŒã€æ€ã£ãŸã‚ˆã‚Šã‚‚é•·ããªã£ã¦ã—ã¾ã„ãã†ã ã£ãŸã®ã§ã€ä¸€åº¦åŒºåˆ‡ã‚Šã‚’ã¤ã‘ã¾ã™ã€‚

ç¶šãã‹ãã¾ã—ãŸ
https://zenn.dev/ndjndj/articles/dc480aa28a7f39


