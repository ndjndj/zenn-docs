---
title: "ã€Ruby on Railsã€‘good_job ã§éåŒæœŸå‡¦ç†"
emoji: "ğŸ“‘"
type: "tech"
topics: []
published: false
---

Rails ã§ API ã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚ã‚ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒã‚³ãƒ¼ãƒ«ã•ã‚ŒãŸã¨ãã€Controller ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ãŒã€ã“ã®ã¨ãã€Controller è‡ªä½“ã®å‡¦ç†ã¨ã¯åˆ¥ã«ã€åˆ†æç”¨ã«ç®¡ç†ã—ã¦ã„ã‚‹ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ›¸ãè¾¼ã¿ã‚’è¡Œã„ãŸã„ã§ã™ã€‚

ã‚­ãƒ¥ãƒ¼ã«ã‚¹ã‚¿ãƒƒã‚¯ã™ã‚‹ã‹ä½•ã‹ã—ã¦ã€è£å´ã§éåŒæœŸã«ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ›¸ãè¾¼ã¿ã‚’è¡Œã£ã¦ãã‚Œã•ãˆã™ã‚Œã°ã‚ˆãã€æ›¸ãè¾¼ã¿ãŒã™ãã«å®Œäº†ã™ã‚‹å¿…è¦ã¯ãªã„ã¨è€ƒãˆã€èª¿ã¹ãŸã¨ã“ã‚ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ ActiveJob ã‚’ç”¨ã„ã‚‹ã“ã¨ã§å®Ÿè£…ãŒã§ããã†ã§ã‚ã‚‹ã¨åˆ¤æ–­ã—ã€ã“ã®æ–¹å‘ã§ãƒ„ãƒ¼ãƒ«ãƒ»gemã‚’æ¤œè¨ã—ã¾ã—ãŸã€‚

ActiveJob ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦ã€Sidekiqã€Resqueã€Delayed Jobã€shoryuken(Amazon SQS)ã€good_job ãŒå€™è£œã«æŒ™ã’ã‚‰ã‚Œã¾ã—ãŸãŒã€Redisã€SQS ã®ç®¡ç†ãƒ»å°å…¥ã‚³ã‚¹ãƒˆã€é–‹ç™ºã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®æ´»ç™ºã•ã‚’è€ƒæ…®ã—ã¦ã€Postgresql ã‚’ä½¿ç”¨ã—ã¦ã„ã‚Œã°ãã®ã¾ã¾å°å…¥ã§ãã‚‹ good_job ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

ActiveJob ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦ good_job ã‚’ä½¿ã£ã¦ã„ã‚‹ã¨ã€‚


# ä¸‹æº–å‚™
ä¸‹æº–å‚™ã¨ã—ã¦ã€ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã® Model ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ãã®ä»–ã‚‚ã‚ã‚‚ã‚ã‚’ä½œã£ã¦ãŠãã¾ã™ã€‚

:::details log ãƒ†ãƒ¼ãƒ–ãƒ«
## model
```
rails g model activity_log
```

```ruby
# db/migrate/xxxxxxxxxxxx_create_activity_log.rb
class CreateActivityLogs < ActiveRecord::Migration[7.1]
  def up
    create_table :activity_logs do |t|
      t.string :user_id, :null => false, comment: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID"
      t.text :log_type, limit: 400, comment: "ãƒ­ã‚°ã®ã‚¿ã‚¤ãƒ—"
      
      t.timestamps
    end
  end

  def down
    drop_table :activity_logs
  end
end
```

```ruby
#app/models/activity_log.rb

class ActivityLog < ApplicationRecord
  validates :uuid, presence: true
end
```

:::

# good_job ã®å°å…¥
**Gemfile**
```
gem "good_job", "~> 3.23.0"
```

**config/initializers/good_job.rb**
```ruby
Rails.application.configure do
  config.good_job.queues = "*"
  config.good_job.execution_mode = :external
  config.good_job.cleanup_preserved_jobs_before_seconds_ago  1.hour.to_i
  config.good_job.max_threads = 3

  GoodJob::Engine.middleware.use(Rack::Auth::Basic) do |username, password|
    ActiveSupport::SecurityUtils.secure_compare(
      Rails.application.credentials.good_job[:username], username
    ) &&
    ActiveSupport::SecurityUtils.secure_compare(
      Rails.application.credentials.good_job[:password], password
    )
  end
end

```
**config.application.rb**

```ruby
config.active_job.queue_adapter = :good_job

```

# good_job ã‚’èµ·å‹•ã™ã‚‹

```bash
bundle exec good_job start
```

# job ã‚’ä½œæˆã™ã‚‹

```bash
rails g job sample
```

