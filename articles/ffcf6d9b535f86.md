---
title: "Rails API + Postgresql ã®ç’°å¢ƒã‚’ Docker ã§æ§‹ç¯‰ã™ã‚‹"
emoji: "ðŸžï¸"
type: "tech"
topics:
  - "docker"
  - "postgresql"
  - "rails"
  - "rails7"
published: true
published_at: "2024-01-10 17:44"
---

`Docker` ã‚’ç”¨ã„ã¦ã€`Ruby on Rails` API ãƒ¢ãƒ¼ãƒ‰ã®é–‹ç™ºç’°å¢ƒã®æ§‹ç¯‰ã‚’è¡Œã£ã¦ã„ãã¾ã™ã€‚
ã‚µãƒ³ãƒ—ãƒ« API ã‚’ä½œæˆã—ã€ç–Žé€šç¢ºèªã™ã‚‹ã¨ã“ã‚ã¾ã§ã‚„ã‚Šã¾ã™ã€‚DB ã¯ä½œæˆã—ã¾ã™ãŒã“ã®è¨˜äº‹ã§ã¯ä½¿ã„ã¾ã›ã‚“ã€‚

# ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

https://github.com/ndjndj/playground/tree/main/rails

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

ã“ã‚“ãªæ„Ÿã˜ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç©ºã®ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã‚’ä½œæˆã—ã¦ãŠãã¾ã™ã€‚

```
.
â”œâ”€ compose.yml
â””â”€ rails
    â”œâ”€ Dockerfile
    â”œâ”€ Gemfile
    â”œâ”€ Gemfile.lock
    â””â”€ entrypoint.sh
```

# compose.yml ãªã©ã®æº–å‚™

`compose.yml` ã§ã€`postgres` ã‚’ä½¿ç”¨ã—ãŸ API ã‚’ä½œæˆã™ã‚‹åˆ¥è¨˜äº‹ã‚’å…¬é–‹ã™ã‚‹é–¢ä¿‚ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã« `postgres` ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€ä»»æ„ã§å¤§ä¸ˆå¤«ã§ã™ã€‚
`Gemfile.lock` ã¯ç©ºã®ã¾ã¾ã§å¤§ä¸ˆå¤«ã§ã™ã€‚
`entrypoint.sh` ã«ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã€æ–°ãŸã«ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã§ããªã„ãŸã‚ã€ãã‚Œã‚’é˜²ããŸã‚ã«èµ·å‹•æ™‚ã«ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã„ã£ãŸã‚“å‰Šé™¤ã™ã‚‹ã‚³ãƒžãƒ³ãƒ‰ãŒè¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚

:::details compose.yml
```yml
version: '3'
services: 
  db: 
    container_name: postgres-sample
    image: postgres:16.0
    ports: 
      - "5432:5432"
    volumes: 
      - pg-data:/var/lib/postgresql/data
    environment: 
      - POSTGRES_DATABASE=postgres 
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password 
      - POSTGRES_ROOT_PASSWORD=root
  api: 
    container_name: api-sample
    build: 
      context: ./rails
    command: bash -c "rails s -b '0.0.0.0'"
    volumes:
      - ./rails:/usr/src/app
    ports: 
      - 3000:3000
    depends_on:
      - db 
    tty: true 
    stdin_open: true
volumes: 
  pg-data:
  bin: 
    driver: local
```
:::

:::details Dockerfile
```Dockerfile
FROM ruby:3.3.0
RUN apt-get update -qq && apt-get install -y vim 

RUN mkdir /usr/src/app 
WORKDIR /usr/src/app
COPY Gemfile /usr/src/app/Gemfile 
COPY Gemfile.lock /usr/src/app/Gemfile.lock 

RUN gem update --system 
RUN bundle update --bundler 

RUN bundle install 
COPY . /usr/src/app 

COPY entrypoint.sh /usr/bin/
RUN chmod +x /usr/bin/entrypoint.sh 
ENTRYPOINT ["entrypoint.sh"]
```
:::

:::details Gemfile
```
source "https://rubygems.org"
git_source(:github) {|repo| "https://github.com/#{repo}.git" }

ruby "3.3.0"

gem "rails", "~> 7.1.2"
```
:::

:::details entrypoint.sh
```bash
#!/bin/bash
set -e

rm -f /usr/src/app/tmp/pids/server.pid 

exec "$@"
```
:::

# Rails ã‚¢ãƒ—ãƒªã®ä½œæˆ

ä¸‹è¨˜ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€`Rails` ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash 
docker compose run --rm api rails new . --skip --database=postgresql --api --skip-bundle
```

:::message
.git ãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã‚‹ã®ã§æ¶ˆåŽ»ã—ã¾ã™ã€‚
:::

## å„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦

å„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚„ãã®ä»–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã¯[ã“ã¡ã‚‰](https://railsdoc.com/page/rails_new)ã‹ã‚‰ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

|ã‚ªãƒ—ã‚·ãƒ§ãƒ³|èª¬æ˜Ž|
|-|-|
|.|ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç›´ä¸‹ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ|
|--force|ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆä¸Šæ›¸ã|
|-skip|ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã‚¹ã‚­ãƒƒãƒ—|
|--database|ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æŒ‡å®š|
|--api|API ã®ã¿ã§ã‚¢ãƒ—ãƒªã‚’ä½œæˆ|
|--skip-bundle|bundle install ã‚’ã‚¹ã‚­ãƒƒãƒ—|

# Gemfile, database.yml ã‚’æ›¸ãæ›ãˆã‚‹
ä»¥ä¸‹ã®ã‚ˆã†ã« `Gemfile` ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚
ã¾ãŸã€`config/database.yml` ã‚‚ä½œæˆã—ãŸç’°å¢ƒã«åˆã‚ã›ã¦æ›¸ãæ›ãˆã¾ã™ã€‚

:::details Gemfile
```Gemfile
source "https://rubygems.org"
git_source(:github) {|repo| "https://github.com/#{repo}.git" }

ruby "3.3.0"

gem "bootsnap", require: false

gem "pg", "~> 1.1"

gem "puma", "~> 6.4.0"

gem "rails", "~> 7.1.2"

gem "tzinfo-data", platforms: %i[mingw mswin x64_mingw jruby]
```
:::

:::details config/database.yml
```yml
default: &default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  username: postgres
  password: password 
  host: db
  port: 5432

development:
  <<: *default
  database: postgres_dev
  password: password

test:
  <<: *default
  database: postgres_test
  password: password
```
:::

# gem ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
ä¸‹è¨˜ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€gem ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
docker compose run --rm api bundle install
```

# Docker ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã‚‹
ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ç«‹ã¡ä¸Šã’ã¾ã™ã€‚

```bash
docker compose build --no-cache
docker compose up -d
```

# Postgresql ã® DB ã‚’ä½œæˆã™ã‚‹
ç¾çŠ¶ã ã¨ DB ãŒå­˜åœ¨ã—ãªã„ãŸã‚ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
`rails` ã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒã«å…¥ã‚Šã¾ã™ã€‚

```bash
docker compose exec api /bin/bash
```

`rails` ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ `db:create` ã—ã¦ DB ã‚’ä½œæˆã—ã¾ã™ã€‚

```
rails db:create
```

# èµ·å‹•ç¢ºèª
ä¸‹è¨˜ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€`Rails` ãŒå‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
localhost:3000
```

![](https://storage.googleapis.com/zenn-user-upload/99d575a3a6fe-20240110.png)

# ã‚µãƒ³ãƒ—ãƒ« API ã‚’ä½œæˆã—ã€å‹•ä½œç¢ºèª
ç°¡æ˜“çš„ãª JSON ã‚’è¿”ã™ã‚µãƒ³ãƒ—ãƒ« API ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚
`rails` ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ä¸‹è¨˜ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

## ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ä½œæˆ
ä¸‹è¨˜ã®ã‚ˆã†ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```bash
rails g controller status
```

:::details status_controller.rb
```rb
class StatusController < ApplicationController
  def index
    render json: {message: "available."}, status: :ok
  end
end
```
:::

## routes.rb ã®è¨­å®š
route ã‚’è¨­å®šã—ã¾ã™ã€‚

:::details config/routes.rb
```rb
Rails.application.routes.draw do
  get "status", to: "status#index"
end
```
:::

## ç–Žé€šç¢ºèª

ä¸Šè¨˜é€šã‚Šã®å®Ÿè£…ãªã‚‰ã€ä¸‹è¨˜ URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã‚Œã° OK ã§ã™ã€‚

```
localhost:3000/status
```

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹

```json 
{"message":"available."}
```

# ã•ã„ã”ã«

`postgresql` ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ã€`rails db:create` ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ã«æ°—ã¥ã‹ãšã¡ã‚‡ã„ã¤ã¾ã¥ã„ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

# å‚è€ƒ
https://zenn.dev/hs7/articles/2cc4d67650ba69
https://railsdoc.com/page/rails_new
https://techguy10308blog.netlify.app/ja/20200510/