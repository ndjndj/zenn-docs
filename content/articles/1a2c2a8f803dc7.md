---
title: "ã€Cognitoã€‘Rails API ã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸ JWT ã®æ¤œè¨¼ã‚’è¡Œã†"
emoji: "ğŸ°"
type: "tech"
topics:
  - "aws"
  - "rails"
  - "ruby"
  - "cognito"
published: true
published_at: "2024-02-08 10:39"
---

Flutter Application ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦ã€Rails ã§ REST API ã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚
èªè¨¼ãƒ»èªå¯ã®å½¹å‰²ãã®ã‚‚ã®ã‚’ API ã‚µãƒ¼ãƒãƒ¼è‡ªä½“ã«æŒãŸã›ãŸããªã‹ã£ãŸãŸã‚ã€Flutter å´ã§ã€Cognito ã‹ã‚‰ç›´æ¥èªè¨¼æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚
ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã«å®Ÿè¡Œã‚’è¨±å¯ã™ã‚‹ API ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«ã€Flutter å´ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ Authorization token(JWT) ã‚’æ¤œè¨¼ã™ã‚‹ä»•çµ„ã¿ã‚’API ã‚µãƒ¼ãƒãƒ¼å´ã«ç”¨æ„ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

JWT ã®æ¤œè¨¼ã«ã¯ã€json-jwt ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
https://github.com/nov/json-jwt

# æ¤œè¨¼ã‚¹ãƒ†ãƒƒãƒ—
AWS ãŒæ¤œè¨¼ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å…¬é–‹ã—ã¦ã„ãŸã®ã§ã€ã“ã¡ã‚‰ã‚’å‚è€ƒã«æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚
    https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-verifying-a-jwt.html

## JWT ãƒˆãƒ¼ã‚¯ãƒ³ã®ç½²åã‚’æ¤œè¨¼
0. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹
    ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¯ã€Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ã« Bearer ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã—ã¦ id token ã‚’å«ã‚ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

    ```
        Authorization: Bearer id-token
    ```
    
    **ID token ã®ä¾‹.(å®Ÿéš›ã¯ã‚‚ã£ã¨é•·ã„ã§ã™)**
    ```
     eyJhbGsInR5cCI6IkpXVCJ9.eyJIwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2
    ```
2. ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¾©å·åŒ–ã™ã‚‹
   å—ã‘å–ã£ãŸ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¾©å·åŒ–ã—ã¾ã™ã€‚
   ID ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€header, payload, signature ã®3ã¤ã® JSON ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚
   ã“ã‚Œã‚‰ã® JSON ã¯ `.` åŒºåˆ‡ã‚Šã§ URL safe ãªå½¢å¼ã§è¡¨ç¾ã•ã‚Œã‚‹ JWT ã¨å‘¼ã°ã‚Œã¾ã™ã€‚
   ãªãŠã€header, payload ã¯ base64 encode ã•ã‚Œã¦ãŠã‚Šã€åˆ©ç”¨ã®éš›ã¯ decode ãŒå¿…è¦ã§ã™ã€‚

   **header**
   ```json
   {
      "kid": "xxxxxxxxxxxxxxxxxxxxxxxxx",
      "alg": "RS256"
    }
   ```

   **payload**

   ```json
   {
      "sub": "xxxxxx-xxxxxx-xxxxxx",
      "email_verified": true,
      "iss": "https://cognito-idp.{region}.amazonaws.com/{pool_id}",
      "cognito:username": "xxxx-xxxx-xxxxx",
      "origin_jti": "yyyy-yyyyyy-yyyyy",
      "aud": "xxxxxxxxxxxxxxxxxxxxxxxxxxxx",
      "event_id": "xxxxxxxx-xxxxxxxxxxx-xxxxxxxxxxxxxx",
      "token_use": "id",
      "auth_time": {unix_time},
      "exp": {unix_time},
      "iat": {unix_time},
      "jti": "xxxxxxxxxx-xxxxxxxxxx-xxxxxxxxxxxxx",
      "email": "example@example.com"
   }
   ```
   
4. å…¬é–‹éµ(JWK) ã® Key ID ã¨ã€ID ãƒˆãƒ¼ã‚¯ãƒ³å´ã® Key ID ã‚’æ¯”è¼ƒã™ã‚‹
5. ç½²åã‚’æ¯”è¼ƒã™ã‚‹     
    ID ãƒˆãƒ¼ã‚¯ãƒ³ã® header ã«ã¯ã€æ¤œè¨¼ã«å¿…è¦ãªæƒ…å ±ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€header ã® kid ã¯å…¬é–‹éµ(JWK) ã® kid ã®æ¯”è¼ƒãŒã§ãã€ã¾ãŸã€alg ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹éµç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‹ã‚‰ã€JWT ã®ç½²åæ¤œè¨¼ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

    å„å±æ€§ã«ã¤ã„ã¦ã¯ã€ã“ã¡ã‚‰ã®è¨˜äº‹ãŒã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚

    https://meetup-jp.toast.com/3511
    https://zenn.dev/mikakane/articles/tutorial_for_jwt

## ã‚¯ãƒ¬ãƒ¼ãƒ ã®æ¤œè¨¼
payload ã‚’æ¤œè¨¼ã—ã¦ã„ãã¾ã™ã€‚
1. æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹
    - exp ã« unixtime ã¨ã—ã¦æ ¼ç´ã•ã‚Œã¦ã„ã‚‹
2. aud ã‚¯ãƒ¬ãƒ¼ãƒ ã¨ Cognito ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã§ä½œæˆã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID ãŒä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
   - aud
3. ç™ºè¡Œè€…(iss) ã‚¯ãƒ¬ãƒ¼ãƒ ã¨ Cognito ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ« ID ãŒä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
   - iss
4. token_use ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ç¢ºèªã™ã‚‹
   - token_use
       - id ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ãªã‚‰ token_use == id ã‚’æ¤œè¨¼ã™ã‚‹

# Ruby ã§æ¤œè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã“ãªã—ã¦ã„ã

## JWT ãƒˆãƒ¼ã‚¯ãƒ³ã®ç½²åã‚’æ¤œè¨¼
å…ˆè¿°ã—ãŸã‚¹ãƒ†ãƒƒãƒ—ã«åˆã‚ã›ã¦ã„ãã¾ã™ã€‚

0. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹
    Bearer ãŒã¤ã„ã¦ã„ã‚‹ã®ã§ã€id-token ã®ã¿ã‚’æŠ½å‡ºã—ã¦ãŠãã¾ã™ã€‚

    ```ruby
        raw_id_token = request.headers["Authorization"]&.split&.last
    ```
    
1. ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¾©å·åŒ–ã™ã‚‹
2. å…¬é–‹éµ(JWK) ã® Key ID ã¨ã€ID ãƒˆãƒ¼ã‚¯ãƒ³å´ã® Key ID ã‚’æ¯”è¼ƒã™ã‚‹
3. ç½²åã‚’æ¯”è¼ƒã™ã‚‹
   json-jwt ã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã¯å…¬é–‹éµã®ãƒªã‚¹ãƒˆã¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¸¡ã™ã ã‘ã§ç½²åã‚’æ¤œè¨¼ã—ã¦ãã‚Œã¾ã™ã€‚
   Cognito ã®å ´åˆã€å…¬é–‹éµã¯è¤‡æ•°ã‚ã‚Šã€ãªãŠã‹ã¤å¤‰æ›´ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãã†ã§ã™ã€‚
   æœ¬ç•ªç’°å¢ƒã§ä½¿ç”¨ã™ã‚‹ãªã‚‰ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ãŒå¿…è¦ã«ãªã‚Šãã†ã§ã™ã€‚

   ```ruby
        # å…¬é–‹éµã‚’å–å¾—
        uri = URI.join(@base_idp_uri, "/#{@pool_id}/.well-known/jwks.json").to_s
        jwks_json = JSON.parse(URI.open(uri).read)
        jwks = JSON::JWK::Set.new(jwks_json)
        # å…¬é–‹éµã®æ¤œè¨¼
        verified_token = JSON::JWT.decode(token, jwks)
        # => payload ãŒè¿”ã£ã¦ãã‚‹
   ```

## ã‚¯ãƒ¬ãƒ¼ãƒ ã®æ¤œè¨¼
payload ã®æ¤œè¨¼ã¯ä¸€æ°—ã«æ›¸ãã¾ã™ã€‚

1. æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹(ç¾åœ¨æ™‚åˆ»ãŒ iat ä»¥é™ã€exp æœªæº€)
2. aud ã‚¯ãƒ¬ãƒ¼ãƒ ã¨ Cognito ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã§ä½œæˆã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID ãŒä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
3. ç™ºè¡Œè€…(iss) ã‚¯ãƒ¬ãƒ¼ãƒ ã¨ Cognito ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ« ID ãŒä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
4. token_use ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ç¢ºèªã™ã‚‹

```ruby
    # claim æ¤œè¨¼
    # æœ‰åŠ¹æœŸé™ã®ç¢ºèª
    return :expired_error unless Time.at(verified_token[:iat]) <= Time.now() &&
                                 Time.at(verified_token[:exp]) > Time.now()
    # id_token ã®ã¿ã‚’è¨±å¯
    return :token_use_error unless verified_token[:token_use] == "id"
    return :client_id_error unless verified_token[:aud] == @client_id
    # ç™ºè¡Œè€…ã®ç¢ºèª
    return :iss_error unless verified_token[:iss] == get_iss()
    # subject(unique)
    return :no_present_sub_error unless verified_token[:sub].present?
```

# ã‚³ãƒ¼ãƒ‰å…¨æ–‡
AuthClient ã¨ã„ã†ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
```ruby
class AuthClient

    def initialize
        @region = ENV["AWS_REGION"]
        @pool_id = ENV["AWS_COGNITO_POOL_ID"]
        @client_id = ENV["AWS_COGNITO_CLIENT_ID"]
        @base_idp_uri = "https://cognito-idp.%s.amazonaws.com" % [ @region ]
    end

    def verification_token(request)
      # "Bearer ~"
      return nil_auth unless request.headers.key?("Authorization")
    
      # Bearer ï½ ã‚’å‰Šé™¤ã—ãŸçŠ¶æ…‹
      token = request.headers["Authorization"]&.split&.last
    
      return :nil_token if token.blank?

      # å…¬é–‹éµã®ã‚»ãƒƒãƒˆã‚’å–å¾—
      jwk_uri = URI.join(@base_idp_uri, "/#{@pool_id}/.well-known/jwks.json").to_s
      jwks_json = JSON.parse(URI.open(jwk_uri).read)
      jwks = JSON::JWK::Set.new(jwks_json)
    
      # å…¬é–‹éµã®æ¤œè¨¼
      begin
        verified_token = JSON::JWT.decode(token, jwks)
      rescue
        return :invalid_token_error
      end
    
      # claim æ¤œè¨¼
      # ç™ºè¡Œè€…ã®ç¢ºèª
      iss = URI.join(@base_idp_uri, "/#{@pool_id}").to_s
      return :iss_error unless verified_token[:iss] == iss
      # id_token ã®ã¿ã‚’è¨±å¯
      return :token_use_error unless verified_token[:token_use] == "id"
      return :client_id_error unless verified_token[:aud] == @client_id
      # subject(unique)
      return :no_present_sub_error unless verified_token[:sub].present?
      # æœ‰åŠ¹æœŸé™ã®ç¢ºèª
      return :expired_error unless Time.at(verified_token[:iat]) <= Time.now() &&
                                   Time.at(verified_token[:exp]) > Time.now()

      return :verify
    end
end
```

# ä½¿ã„æ–¹
å…ˆã»ã©ã® `verification_token` ã‚’ã€controller ã® before_action ã«æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

**app/controllers/api/v1/base_controller.rb**
```ruby
require "./lib/auth/cognito/cognito_client"

class Api::V1::BaseController < ApplicationController

  def verification_user
    client = AuthClient.new()
    auth = client.verification_token(request)
    if auth != :verify
      render json: {
        error: "Invalid token #{auth}",
        status: :unauthorized
      }
      return
    end
  end
end
```

**app/controllers/api/v1/soregashi_controller.rb**
```ruby
class Api::V1::SoregashiController < Api::V1::BaseController
  before_action :verification_user

  def index
    render json: {message: "Soregashi"}, status: :ok
  end
end
```

# å‚è€ƒ

https://github.com/nov/json-jwt/wiki
https://qiita.com/TakahikoKawasaki/items/498ca08bbfcc341691fe
https://qiita.com/TakahikoKawasaki/items/e37caf50776e00e733be
https://qiita.com/ya-mada/items/154ea6e10f9f788bfdd5
https://qiita.com/tmak_tsukamoto/items/109ed73546e6522f4424
https://zenn.dev/mikakane/articles/tutorial_for_jwt
https://meetup-jp.toast.com/3511
https://ritou.hatenablog.com/entry/2020/03/31/142550
https://github.com/mheffner/rails-cognito-example/tree/master
