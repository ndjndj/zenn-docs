---
title: "ã€Flutter/connectivity_plusã€‘ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã‚’ç›£è¦–ã™ã‚‹"
emoji: "ğŸ¥"
type: "tech"
topics:
  - "android"
  - "flutter"
  - "ios"
published: true
published_at: "2023-12-21 10:10"
---

é€šä¿¡ã‚’è¡Œã† iOS/Android ã‚¢ãƒ—ãƒªã‚’ Flutter ã§é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«æ¥ç¶šã•ã‚Œã¦ã„ãªã„å ´åˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãŸã‹ã£ãŸãŸã‚ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã‚’ç›£è¦–ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ãŸã®ã§ã€å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¾ã™ã€‚

# ä»Šå›ä½œæˆã—ãŸã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

https://github.com/ndjndj/flutter_connectivity_sample

# è¦ç´„
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã®ç›£è¦–ã«ã¯ `connectivity_plus` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹
- `ConnectivityResult` ã‚’çŠ¶æ…‹ã¨ã—ã¦ä¿æŒã™ã‚‹
- `StreamSubscription` ã‚’åˆ©ç”¨ã—ã¦ã€çŠ¶æ…‹ã¨ã—ã¦ä¿æŒã—ã¦ã„ã‚‹ `ConnectivityResult` ã‚’ç›£è¦–ã™ã‚‹
- ä¿æŒã—ã¦ã„ã‚‹çŠ¶æ…‹ã«å¿œã˜ã¦è¡¨ç¤ºã™ã‚‹ `Widget` ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
- `ConnectivityResult` ã¯ãƒ¢ãƒã‚¤ãƒ«é€šä¿¡(mobile)ã‚„ Wi-Fi é€šä¿¡(wifi)ãªã©ãŒã‚ã‚‹

# connectivity_plus ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã™ã‚‹
`connectivity_plus` ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™
é€šå¸¸ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆ©ç”¨ã¨åŒæ§˜ã®æ‰‹æ³•ã§ã€`flutter pub add connectivity_plus` ã‚’ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãªã©ã§å®Ÿè¡Œã™ã‚‹ã‹ã€`pubspec.yaml` ã® dependencies ã«è¨˜è¿°ã‚’è¿½åŠ ã—ã¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å°å…¥ã—ã¾ã™

https://pub.dev/packages/connectivity_plus

# ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã«å¿œã˜ã¦è¡¨ç¤ºã™ã‚‹ `Widget` ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã ã‘ã®ç°¡æ˜“çš„ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™

- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã¤ãªãŒã£ã¦ã„ã‚‹ã¨ã
	- é€šå¸¸ã®ç”»é¢(`connectivity_sample` ã¨è¡¨ç¤ºã™ã‚‹ã ã‘ã®ç”»é¢)ã‚’è¡¨ç¤º
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã¤ãªãŒã£ã¦ã„ãªã„ã¨ã
	- é€šå¸¸ã®ç”»é¢æ“ä½œã‚’ã™ã‚‹ã“ã¨ãŒã§ããªã„ã‚ˆã†ã«ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹

## main.dart
:::details ã‚³ãƒ¼ãƒ‰å…¨æ–‡
```dart
import 'package:flutter/material.dart';
import 'package:flutter_connectivity_sample/src/connectivity_sample.dart';

void main() {
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Flutter Connectivity Sample',
      theme: ThemeData(
        colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),
        useMaterial3: true,
      ),
      home: const MyHomePage(
        title: 'Flutter Connectivity Sample'
      ),
    );
  }
}

class MyHomePage extends StatelessWidget {
  const MyHomePage({super.key, required this.title});

  final String title;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        backgroundColor: Theme.of(context).colorScheme.inversePrimary,
        title: Text(title),
      ),
      body: const ConnectivitySample(
        child: Center(
          child: Text(
            'connectivity sample',
          ),
        ),
      )
    );
  }
}
```
:::

## connectivity_sample.dart
:::details ã‚³ãƒ¼ãƒ‰å…¨æ–‡
```dart
import 'dart:async';

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:connectivity_plus/connectivity_plus.dart';
import 'package:flutter_connectivity_sample/src/not_connection.dart';

class ConnectivitySample extends StatefulWidget {
  const ConnectivitySample({
    super.key,
    required this.child
  });

  final Widget child;

  @override 
  State<ConnectivitySample> createState() => _State();
}

class _State extends State<ConnectivitySample> {
  ConnectivityResult connectionStatus = ConnectivityResult.none;
  final Connectivity connectivity = Connectivity();
  late StreamSubscription<ConnectivityResult> connectivitySubscription;

  @override 
  void initState() {
    super.initState();
    initConnectivity();
    connectivitySubscription = connectivity.onConnectivityChanged.listen(updateConnectionStatus);
  }

  @override 
  void dispose() {
    connectivitySubscription.cancel();
    super.dispose();
  }

  Future<void> initConnectivity() async {
    late ConnectivityResult result;
    try {
      result = await connectivity.checkConnectivity();
    } on PlatformException catch(_) {
      return;
    }

    if (!mounted) {
      return;
    }
    
    updateConnectionStatus(result);
  }

  Future<void> updateConnectionStatus(ConnectivityResult result) async {
    setState(() {
      connectionStatus = result;
    });
  }

  @override 
  Widget build(BuildContext context) {
    return connectionStatus == ConnectivityResult.none 
    ? const NotConnection()
    : widget.child;
  }
}
```
:::

## not_connection.dart
:::details ã‚³ãƒ¼ãƒ‰å…¨æ–‡
```dart
import 'package:flutter/material.dart';

class NotConnection extends StatelessWidget {
  const NotConnection({
    super.key
  });

  @override
  Widget build(BuildContext context) {
    return const AlertDialog(
      title: Text("not connection"),
      content: SizedBox(
        width: 200,
        height: 200,
        child: Text("network error."),
      ),
    );
  }
}
```
:::

## ConnectivityResult ã‚’çŠ¶æ…‹ã¨ã—ã¦ä¿æŒã™ã‚‹
`ConnectivityResult` ã‚’çŠ¶æ…‹ã¨ã—ã¦ä¿æŒã—ã¾ã™
enum ã§ `none`, `mobile`, `wifi` ãªã©ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã‚ã‚Šã¾ã™
ä»Šå›ã¯ `none` ã®ã¿ã®ä½¿ç”¨ã§ã™ãŒã€ãƒ¢ãƒã‚¤ãƒ«é€šä¿¡ã¨ Wi-Fi é€šä¿¡ã®é•ã„ã§å‡¦ç†ã‚’åˆ†ã‘ãŸã„å ´åˆ(è¡¨ç¤ºã™ã‚‹ç”»åƒã®ç”»è³ªã‚’å¤‰ãˆã‚‹ãªã©)ã¯æ´»ç”¨ã§ããã†ã§ã™

https://pub.dev/documentation/connectivity_plus/latest/connectivity_plus/ConnectivityResult.html

```dart
ConnectivityResult connectionStatus = ConnectivityResult.none;

Future<void> updateConnectionStatus(ConnectivityResult result) async {
  setState(() {
    connectionStatus = result;
  });
}
```


## StreamSubscription ã‚’ç”¨ã„ã¦ ConnectivityResult ã‚’ç›£è¦–ã™ã‚‹
`StreamSubscription` ã‚’ç”¨ã„ã¦ã€`State` ã¨ã—ã¦ä¿æŒã—ã¦ã„ã‚‹ `ConnectivityResult` ã‚’ç›£è¦–ã—ã¾ã™

```dart
@override 
void initState() {
  super.initState();
  initConnectivity();
  connectivitySubscription = connectivity.onConnectivityChanged.listen(updateConnectionStatus);
}

Future<void> updateConnectionStatus(ConnectivityResult result) async {
  setState(() {
    connectionStatus = result;
  });
}
```

### StreamSubscription ã«ã¤ã„ã¦ã¯ã“ã¡ã‚‰

https://api.flutter.dev/flutter/dart-async/StreamSubscription-class.html
https://ta-watanabe.hatenablog.com/entry/2021/08/04/234412
https://www.educative.io/answers/what-is-the-streamsubscription-class-in-dart

## State ã«å¿œã˜ã¦è¡¨ç¤ºã™ã‚‹ Widget ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
`State` ã«å¿œã˜ã¦ã€è¡¨ç¤ºã™ã‚‹ `Widget` ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™
ä»Šå›ã¯ `NotConnection` ã¨ã„ã†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™

```dart
@override 
Widget build(BuildContext context) {
  return connectionStatus == ConnectivityResult.none 
  ? const NotConnection()
  : widget.child;
}
```

## main.dart ã® Widget ã«è¿½åŠ ã™ã‚‹
`connectivity_sample.dart` ã«ã¯ `child` ã¨ã—ã¦ `Widget` ã‚’æ¸¡ã›ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™
è¦ª `Widget` ã‹ã‚‰ `ConnectivitySample` ã‚’å‘¼ã³å‡ºã—ã€ãã® `child` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã¤ãªãŒã£ã¦ã„ã‚‹çŠ¶æ…‹ã§è¡¨ç¤ºã—ãŸã„ `Widget` ã‚’æ¸¡ã—ã¾ã™

```dart
@override
Widget build(BuildContext context) {
  return Scaffold(
    appBar: AppBar(
      backgroundColor: Theme.of(context).colorScheme.inversePrimary,
      title: Text(title),
    ),
    body: const ConnectivitySample(
      child: Center(
        child: Text(
          'connectivity sample',
        ),
      ),
    )
  );
}
```

## å®Ÿéš›ã®å‹•ä½œç”»é¢
### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã¤ãªãŒã£ã¦ã„ã‚‹ã¨ã
ConnectivityResult.none ã˜ã‚ƒãªã„ã¨ã
![](https://storage.googleapis.com/zenn-user-upload/48a934457d18-20231221.png =250x)

### é€šä¿¡ã‚’ãã‚‹
![](https://storage.googleapis.com/zenn-user-upload/f7c9745105a7-20231221.png =250x)

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã¤ãªãŒã£ã¦ã„ãªã„ã¨ã
ConnectivityResult.none ã®ã¨ã
![](https://storage.googleapis.com/zenn-user-upload/401dce5c85ee-20231221.png =250x)

å†ã³é€šä¿¡ã‚’ ON ã«ã™ã‚Œã°å…ƒã®ç”»é¢ã«æˆ»ã‚Šã¾ã™

# å‚è€ƒ
## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
https://pub.dev/packages/connectivity_plus
https://pub.dev/documentation/connectivity_plus/latest/index.html

## å®Ÿè£…ã«ã¤ã„ã¦
https://medium.com/vipin-vijayan/network-connectivity-in-flutter-78aa49314340
https://gist.github.com/sbosell/d47b5c4a6fb2be90a686e0fcc95b9bc0

## Stream ã«ã¤ã„ã¦
https://api.flutter.dev/flutter/dart-async/StreamSubscription-class.html
https://ta-watanabe.hatenablog.com/entry/2021/08/04/234412
https://www.educative.io/answers/what-is-the-streamsubscription-class-in-dart

## ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
https://github.com/ndjndj/flutter_connectivity_sample

# ã•ã„ã”ã«
ä»Šå›ã¯è¡¨ç¤ºã™ã‚‹ `Widget` ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã¤ãªãŒã£ã¦ã„ãªã„ã¨ãã¯ã‚¢ãƒ—ãƒªè‡ªä½“ã®åˆ©ç”¨ã‚’åˆ¶é™ã™ã‚‹ã‚ˆã†ãªå®Ÿè£…ã§ã™ãŒã€ä¸€éƒ¨æ©Ÿèƒ½ã®åˆ¶é™ãªã©ã‚’ã—ãŸã„å ´åˆã¯çŠ¶æ…‹ç®¡ç†ã®æ–¹æ³•ã« `Riverpod` ã‚’åˆ©ç”¨ã—ã¦çŠ¶æ…‹ã ã‘ã‚’åˆ‡ã‚Šå‡ºã™ãªã©ã€ã‚‚ã†å°‘ã—å·¥å¤«ãŒå¿…è¦ãã†ã§ã™

ã¾ãŸã€`connectivity_plus` ã¯ iOS/Android ã®ã»ã‹ã€ä»–ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ã‚‚å¯¾å¿œã—ã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãªã®ã§ã€Web ã‚¢ãƒ—ãƒªã‚„ iOS/Android ä»¥å¤–ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã«åŒæ§˜ã®ä»•çµ„ã¿ã‚’å®Ÿè£…ã—ãŸã„å ´åˆã«ã‚‚å½¹ç«‹ã¤ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸ

ä»¥ä¸Šã§ã™
ã“ã“ã¾ã§èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼
