---
title: "Dynamoid ã§ where ã‚’å®Ÿè¡Œã—ãŸã‚‰ Chain ã‚¯ãƒ©ã‚¹ãŒè¿”ã‚‹ã®ã§ ActiveModelSerializer ã¯åŠ¹ã‹ãªã„ã‚‰ã—ã„"
emoji: "ğŸ°"
type: "tech"
topics:
  - "aws"
  - "rails"
  - "ruby"
  - "dynamodb"
published: true
published_at: "2024-02-07 16:46"
---

Ruby on Rails ã§ DynamoDB ã‚’ ActiveRecord ã®ã‚ˆã†ã«æ‰±ãˆã‚‹ Dynamoid ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
Controller ã‹ã‚‰ã€ã¨ã‚ã‚‹ãƒ¢ãƒ‡ãƒ«ã®é…åˆ—ã‚’è¿”ã—ãŸã‹ã£ãŸã®ã§ã™ãŒã€ã†ã¾ã ActiveModelSerializer ãŒåƒã‹ãšã„ã‚ã„ã‚èª¿ã¹ãŸã®ã§å‚™å¿˜éŒ²ã¨ã—ã¦ã¾ã¨ã‚ã¾ã™ã€‚

2024/02/19 14:10 pluck ãƒ¡ã‚½ãƒƒãƒ‰ã«é–¢ã™ã‚‹è¨˜è¿°ã‚’è¿½åŠ 

# çµè«–
- where ã§ã¯ Dynamoid::Criteria::Chain ã‚¯ãƒ©ã‚¹ãŒè¿”ã‚‹ã®ã§ã€to_a ãªã©ã§å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- project ãƒ¡ã‚½ãƒƒãƒ‰ã§åˆ—æŒ‡å®šã¯ã§ãã‚‹ã‘ã©ã€STI ã—ã¦ã„ã‚‹ã¨ type åˆ—ã‚‚è¿”ã£ã¦ãã‚‹ã®ã§ serializer ã¨ã®ä½µç”¨ãŒãŠã™ã™ã‚
- pluck ãƒ¡ã‚½ãƒƒãƒ‰ãªã‚‰ã€åˆ—æŒ‡å®šã—ãŸã†ãˆã§ type åˆ—ã‚’å«ã¾ãªã„é…åˆ—ã‚’è¿”ã›ã¾ã™

# å•é¡Œã«ãªã£ãŸã‚³ãƒ¼ãƒ‰
ãƒ¢ãƒ‡ãƒ«åãªã©ã¯æ¶ç©ºã§ã™ã€‚
ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å±æ€§ä¸€è¦§ã‚’å–å¾—ã™ã‚‹ã‚¯ã‚¨ãƒªã§ã€JSON ã®é…åˆ—ã‚’å–å¾—ã™ã‚‹æƒ³å®šã§ã™ã€‚

**./app/controllers/api/v2/user_controller.rb**
```ruby
class Api::V2::UserController < Api::V2::BaseController
  def index
    user_id = params[:id]
    r = User.where(
      pk: "U_##{user_id}",
      "sk.begins_with": "attributes_#"
    )

    render json: r,
           root: 'data',
           adapter: :json,
           each_serializer: UserSerializer,
           status: :ok,
           status_code: 200
    
  end
end
```

**./app/serializers/user_serializer.rb**
```ruby
class UserSerializer < ActiveModel::Serializer
  attributes :attribute_id, :attribute
end
```

ã“ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã¨ã€serializer ãŒåŠ¹ã‹ãšã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¾ã™ã€‚

```json
[
    {
        "data: {
            "id": "xxxx",
            "attribute_id": "xxxx",
            "name": "xxxx",
            "attribute_name": "xxxx"
        }
    },
    {
        "data: {
            "id": "xxxx",
            "attribute_id": "xxxx",
            "name": "xxxx",
            "attribute_name": "xxxx"
        }
    } # ç•¥....
]
```

ç†æƒ³å½¢ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```json
{
    "data": [
        {
            "id": "xxxx",
            "attribute_id": "xxxx"
        },
        {
            "id": "xxxx",
            "attribute_id": "xxxx"
        } # ç•¥....
    ]
}
```

# åŸå› 
User.where ã®è¿”ã‚Šå€¤ãŒ Dynamoid::Criteria::Chain ã§ã‚ã‚Šã€Array ã§ã¯ãªã„ãŸã‚ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ä½œç”¨ã™ã‚‹ each_serializer ãŒåŠ¹ã‹ãªã‹ã£ãŸã¨æ€ã‚ã‚Œã‚‹ï¼ˆChain ã‚¯ãƒ©ã‚¹ã® superclass ãŒ Object ã ã£ãŸï¼‰ã€‚

https://github.com/rails-api/active_model_serializers/blob/0-10-stable/docs/general/rendering.md#serializer

# å¯¾ç­–
array ã«å¤‰æ›ã—ã¦ã‹ã‚‰ render ã™ã‚‹ã€‚

**./app/controllers/api/v2/user_controller.rb**
```ruby
class Api::V2::UserController < Api::V2::BaseController
  def index
    user_id = params[:id]
    r = User.where(
      pk: "U_##{user_id}",
      "sk.begins_with": "attributes_#"
    )

    render json: r.to_a,
    root: 'data',
    adapter: :json,
    each_serializer: UserSerializer,
    status: :ok,
    status_code: 200
    
  end
end
```

ã¡ãªã¿ã«ã€where ã®ã‚ã¨ã«ã€`project` ãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒã‚§ãƒ¼ãƒ³ã™ã‚Œã°æŒ‡å®šåˆ—ã®æŠ½å‡ºãŒã§ãã¾ã™ãŒã€STI(å˜ä¸€ãƒ†ãƒ¼ãƒ–ãƒ«ç¶™æ‰¿) ã—ã¦ã„ã‚‹ã¨ type åˆ—ã‚‚è¿”ã£ã¦ãã¦ã—ã¾ã†ã®ã§ serializer ã‚‚ä½µç”¨ã—ãŸã„ã¨ã“ã‚ã§ã™ã€‚

```ruby
r = User.where(
  pk: "U_##{user_id}",
  "sk.begins_with": "attributes_#"
).project(:id)
# User ãŒãªã‚“ã‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹ã¨ã€type åˆ—ã‚‚è¿”ã£ã¦ãã‚‹
# ä¾‹) [#<User pk: nil, sk:nil, id: xxx, type: "User",....>, #<User ....>, ...]
```

ã¾ãŸã€`pluck` ãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒã‚§ãƒ¼ãƒ³ã™ã‚Œã°æŒ‡å®šåˆ—ã®æŠ½å‡ºãŒã§ãã‚‹ã‹ã¤ã€Array ã«å¤‰æ›ã§ãã‚‹ã®ã§ç”¨é€”ãŒæ±ºã¾ã£ã¦ã„ã‚‹ã®ãªã‚‰ã“ã®æ–¹æ³•ãŒã„ã„ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ã€‚

```ruby
r = User.where(
  pk: "U_##{user_id}",
  "sk.begins_with": "attributes_#"
).pluck(:id)
# ä¾‹) [1, 2, 3 ...]
```


# å‚è€ƒ
https://github.com/rails-api/active_model_serializers/blob/0-10-stable/docs/general/rendering.md#serializer
https://rubydoc.info/github/Dynamoid/dynamoid/Dynamoid/Criteria/Chain#pluck-instance_method