---
title: "Rails Ã— ruby-spacy ç’°å¢ƒã‚’ Docker ã§æ§‹ç¯‰ã—ã¦è‡ªç„¶è¨€èªå‡¦ç†ã«å…¥é–€ã™ã‚‹"
emoji: "ğŸï¸"
type: "tech"
topics:
  - "docker"
  - "rails"
  - "python3"
  - "spacy"
published: true
published_at: "2024-03-22 11:35"
---

Rails ã§æ§‹ç¯‰ã—ã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§è‡ªç„¶è¨€èªå‡¦ç†ã‚’è¡Œã„ãŸã‹ã£ãŸã®ã§ã€Ruby ã§è‡ªç„¶è¨€èªå‡¦ç†ã‚’è¡Œãˆã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã® ruby-spacy ã®æ¤œè¨¼ã‚’è¡Œã†ãŸã‚ã« docker ã§ç’°å¢ƒæ§‹ç¯‰ã‚’è¡Œã†ã“ã¨ã«ã—ã¾ã—ãŸã€‚
å¾Œè¿°ã—ã¾ã™ãŒã€å˜ãªã‚‹ gem ã§ã¯ãªãã‚ã‚‹ç¨‹åº¦æº–å‚™ãŒå¿…è¦ãªã‚‚ã®ã§ã€ã¯ã¾ã£ãŸå€‹æ‰€ã‚‚ã„ãã¤ã‹ã‚ã£ãŸã®ã§ã€å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¾ã™ã€‚

# ruby-spacy ã¨ã¯
ruby-spacy ã¨ã¯ [Yoichiro Hasebe](https://github.com/yohasebe) ã•ã‚“ã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€Python ç”¨ã®è‡ªç„¶è¨€èªå‡¦ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ spaCy ã‚’ Ruby ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

https://github.com/yohasebe/ruby-spacy

spaCy ã¨ã¯ã€Python/Cython ã§æ§‹ç¯‰ã•ã‚ŒãŸè‡ªç„¶è¨€èªå‡¦ç†ã‚’è¡Œã†ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€è¨“ç·´æ¸ˆã¿ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

å‚è€ƒ: https://spacy.io/
å‚è€ƒ: https://ja.wikipedia.org/wiki/SpaCy

ã¾ãŸã€æ—¥æœ¬èªã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æã™ã‚‹ãŸã‚ã®è¨€èªãƒ¢ãƒ‡ãƒ«ã§ã‚ã‚Šã€ãƒªã‚¯ãƒ«ãƒ¼ãƒˆã¨å›½ç«‹å›½èªç ”ç©¶æ‰€ã®å…±åŒç ”ç©¶ã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚ŒãŸ GiNZA ã‚’ spaCy ã§ã‚‚ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

å‚è€ƒ: https://www.recruit.co.jp/newsroom/2019/0402_18331.html

ä¸Šè¨˜ã®ã‚ˆã†ã«ã€ruby-spacy ã§ã¯ Python ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ spaCy ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚
å†…éƒ¨ã§ PyCall ã¨ã„ã† Ruby ã‹ã‚‰ Python ã‚’å‘¼ã³å‡ºã™ãŸã‚ã® gem ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€Rails ç’°å¢ƒã®ä¸­ã« Python ç’°å¢ƒã‚’åŒå±…ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

# ã‚µãƒ³ãƒ—ãƒ«ãƒªãƒã‚¸ãƒˆãƒª

https://github.com/ndjndj/rails-spacy

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
ã“ã‚“ãªæ„Ÿã˜ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç©ºã®ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã‚’ä½œæˆã—ã¦ãŠãã¾ã™ã€‚

```
.
â”œâ”€ compose.yml
â””â”€ rails
    â”œâ”€ Dockerfile
    â”œâ”€ Gemfile
    â”œâ”€ Gemfile.lock
    â””â”€ entrypoint.sh
```

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã« `postgres` ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€ä»Šå›ã¯ä½¿ç”¨ã—ãªã„ã®ã§ä»»æ„ã§å¤§ä¸ˆå¤«ã§ã™ã€‚
`Gemfile.lock` ã¯ç©ºã®ã¾ã¾ã§å¤§ä¸ˆå¤«ã§ã™ã€‚
`entrypoint.sh` ã«ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã€æ–°ãŸã«ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã§ããªã„ãŸã‚ã€ãã‚Œã‚’é˜²ããŸã‚ã«èµ·å‹•æ™‚ã«ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã„ã£ãŸã‚“å‰Šé™¤ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ãŒè¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚

:::details compose.yml
```yml
version: '3'
services: 
  db: 
    container_name: postgres-spacy-sample
    image: postgres:16.0
    ports: 
      - "5432:5432"
    volumes: 
      - pg-data:/var/lib/postgresql/data
    environment: 
      - POSTGRES_DATABASE=postgres 
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password 
      - POSTGRES_ROOT_PASSWORD=root
  api: 
    container_name: api-spacy-sample
    build: 
      context: ./rails
    command: /bin/bash
    volumes:
      - ./rails:/usr/src/app
    ports: 
      - 3000:3000
    depends_on:
      - db 
    tty: true 
    stdin_open: true
volumes: 
  pg-data:
  bin: 
    driver: local
```
:::

:::details Dockerfile
```Dockerfile
FROM ruby:3.3.0
RUN apt-get update -qq && apt-get install -y vim 

RUN apt-get install -y build-essential
RUN apt-get install -y curl wget zip git

RUN git clone https://github.com/pyenv/pyenv.git ~/.pyenv
RUN [ \
    "/bin/bash", "-c", \
    " \
        source ~/.bashrc \
        && echo 'export PYENV_ROOT=\"$HOME/.pyenv\"' >> ~/.bashrc \
        && echo 'command -v pyenv >/dev/null || export PATH=\"$PYENV_ROOT/bin:$PATH\"' >> ~/.bashrc \
        && echo 'eval \"$(pyenv init -)\"' >> ~/.bashrc \
        && source ~/.bashrc \
        && export CONFIGURE_OPTS=\"--enable-shared\" \
        && pyenv install 3.10.6 \
        && pyenv global 3.10.6 \
        && pip install spacy==3.6.0 \
        && pip install ginza==5.1.3 \
        && python -m spacy download ja_core_news_sm \
    "] 

RUN mkdir /usr/src/app 
WORKDIR /usr/src/app
COPY Gemfile /usr/src/app/Gemfile 
COPY Gemfile.lock /usr/src/app/Gemfile.lock 

RUN gem update --system 
RUN bundle update --bundler 

RUN bundle install 
COPY . /usr/src/app 

COPY entrypoint.sh /usr/bin/
RUN chmod +x /usr/bin/entrypoint.sh 
ENTRYPOINT ["entrypoint.sh"]
```
:::

:::details Gemfile
```
source "https://rubygems.org"
git_source(:github) {|repo| "https://github.com/#{repo}.git" }

ruby "3.3.0"

gem "rails", "~> 7.1.2"
```
:::

:::details entrypoint.sh
```bash
#!/bin/bash
set -e

rm -f /usr/src/app/tmp/pids/server.pid 

exec "$@"
```
:::

# Rails ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€`Rails` ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash 
docker compose run --rm api rails new . --skip --database=postgresql --api --skip-bundle
```

:::message
.git ãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã‚‹ã®ã§æ¶ˆå»ã—ã¾ã™ã€‚
:::

# Gemfile, database.yml ã‚’æ›¸ãæ›ãˆã‚‹
ä»¥ä¸‹ã®ã‚ˆã†ã« `Gemfile` ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚
ã¾ãŸã€`config/database.yml` ã‚‚ä½œæˆã—ãŸç’°å¢ƒã«åˆã‚ã›ã¦æ›¸ãæ›ãˆã¾ã™ã€‚

:::details Gemfile
```Gemfile
source "https://rubygems.org"
git_source(:github) {|repo| "https://github.com/#{repo}.git" }

ruby "3.3.0"

gem "bootsnap", require: false

gem "pg", "~> 1.1"

gem "puma", "~> 6.4.0"

gem "rails", "~> 7.1.2"

gem "ruby-spacy", "~> 0.2.2"

gem "tzinfo-data", platforms: %i[mingw mswin x64_mingw jruby]
```
:::

:::details config/database.yml
```yml
default: &default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  username: postgres
  password: password 
  host: db
  port: 5432

development:
  <<: *default
  database: postgres_dev
  password: password

test:
  <<: *default
  database: postgres_test
  password: password
```
:::

# gem ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€gem ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
docker compose run --rm api bundle install
```

# Docker ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã‚‹
ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ç«‹ã¡ä¸Šã’ã¾ã™ã€‚

```bash
docker compose build --no-cache
docker compose up -d
```

# Postgresql ã® DB ã‚’ä½œæˆã™ã‚‹
ç¾çŠ¶ã ã¨ DB ãŒå­˜åœ¨ã—ãªã„ãŸã‚ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
`rails` ã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒã«å…¥ã‚Šã¾ã™ã€‚

```bash
docker compose exec api /bin/bash
```

`rails` ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ `db:create` ã—ã¦ DB ã‚’ä½œæˆã—ã¾ã™ã€‚

```
rails db:create
```

# spaCy ã®å°å…¥ã«ã¤ã„ã¦
å…ˆè¿°ã—ãŸã‚ˆã†ã« ruby-spacy ã¯ã€Python ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã® spaCy ã®ãƒ©ãƒƒãƒ‘ãƒ¼ãªã®ã§åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€Python ã®ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
Dockerfile ã§è©²å½“ã™ã‚‹éƒ¨åˆ†ã‚’ä»¥ä¸‹ã«è¨˜ã—ã¾ã™ã€‚

```
# Dockerfile
# ( ä¸­ç•¥ )
RUN apt-get install -y build-essential
RUN apt-get install -y curl wget zip git

RUN git clone https://github.com/pyenv/pyenv.git ~/.pyenv
RUN [ \
    "/bin/bash", "-c", \
    " \
        source ~/.bashrc \
        && echo 'export PYENV_ROOT=\"$HOME/.pyenv\"' >> ~/.bashrc \
        && echo 'command -v pyenv >/dev/null || export PATH=\"$PYENV_ROOT/bin:$PATH\"' >> ~/.bashrc \
        && echo 'eval \"$(pyenv init -)\"' >> ~/.bashrc \
        && source ~/.bashrc \
        && export CONFIGURE_OPTS=\"--enable-shared\" \
        && pyenv install 3.10.6 \
        && pyenv global 3.10.6 \
        && pip install spacy==3.6.0 \
        && pip install ginza==5.1.3 \
        && python -m spacy download ja_core_news_sm \
    "]
# ( ä¸­ç•¥ )
```

## bash ã‚’ä½¿ã†
å¾Œè¿°ã™ã‚‹ç†ç”±ã«ã‚ˆã‚Šã€ç›´æ¥ Python ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã›ãšã«ã€Pyenv ã‚’ç”¨ã„ã¦ Python ã®ä»®æƒ³ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
dockerfile ã§ RUN ã‚³ãƒãƒ³ãƒ‰ã‚’æ›¸ãã¨ /bin/sh ãŒä½¿ã‚ã‚Œã¾ã™ãŒã€sh ã ã¨ã€pyenv ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒã§ããªã‹ã£ãŸã®ã§ã€bash ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```
RUN [ \
    "/bin/bash", "-c", \
    ( ä¸­ç•¥ )
```

## pyenv ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ç›´æ¥ Python ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã“ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ pip install ã™ã‚‹ã¨ã€PEP 668 ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

```
RUN apt-get install -y curl wget zip git

RUN git clone https://github.com/pyenv/pyenv.git ~/.pyenv
RUN [ \
    "/bin/bash", "-c", \
    " \
        source ~/.bashrc \
        && echo 'export PYENV_ROOT=\"$HOME/.pyenv\"' >> ~/.bashrc \
        && echo 'command -v pyenv >/dev/null || export PATH=\"$PYENV_ROOT/bin:$PATH\"' >> ~/.bashrc \
        && echo 'eval \"$(pyenv init -)\"' >> ~/.bashrc \
        && source ~/.bashrc \
```

:::message
PEP 668 ã¨ã¯ã€Python ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«é–¢ã™ã‚‹ææ¡ˆã§ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç®¡ç†ã™ã‚‹ã®ã§ã¯ãªãã€ä»®æƒ³ç’°å¢ƒå†…ã§ç®¡ç†ã—ã‚ˆã†ã‚ˆï¼ã¨ã„ã†ææ¡ˆã§ã™[^1]ã€‚
Debian ãªã©ã§ã¯ PEP 668 ã«æº–æ‹ ã—ã¦ã„ãªã„å ´åˆã¯ pip install ã‚’æ‹’å¦ã™ã‚‹ã¿ãŸã„ã§ã™ã€‚

https://peps.python.org/pep-0668/
:::

## ruby-spacy ã®æ¡ˆå†…ã«ã—ãŸãŒã†
ruby-spacy ã® README ã«å¾“ã„ã€enable-shared ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹ã«ã—ã€spaCy ã¨ è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãã¾ã™ã€‚ä»Šå›ã¯è¨€èªãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ ja_core_news_sm ã‚’å°å…¥ã—ã¦ã„ã¾ã™ã€‚

```
        && export CONFIGURE_OPTS=\"--enable-shared\" \
        && pyenv install 3.10.6 \
        && pyenv global 3.10.6 \
        && pip install spacy==3.6.0 \
        && pip install ginza==5.1.3 \
        && python -m spacy download ja_core_news_sm \
    "]
```

# rails console ã§ç¢ºèªã™ã‚‹
docker build ã¨ docker up ãŒå®Œäº†ã—ãŸã‚‰ã€rails ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚Šã€Rails ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã—ã¦ã€ruby-spacy çµŒç”±ã§ã€spaCy ã‚’å‘¼ã³å‡ºã›ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ ruby-spacy ã® README ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã§ã™ã€‚

```
rails c
```

```rb
require "ruby-spacy"
require "terminal-table"

nlp = Spacy::Language.new("ja_core_news_sm") # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸè¨€èªãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®š
doc = nlp.read("ä»»å¤©å ‚ã¯1983å¹´ã«ãƒ•ã‚¡ãƒŸã‚³ãƒ³ã‚’14,800å††ã§ç™ºå£²ã—ãŸã€‚")

headings = ["text", "lemma", "pos", "tag", "dep"]
rows = []

doc.each do |token|
  rows << [token.text, token.lemma, token.pos, token.tag, token.dep]
end

table = Terminal::Table.new rows: rows, headings: headings
puts table
```

# ã•ã„ã”ã«
spaCy ã‚’å‘¼ã³å‡ºã™ ruby-spacy ã®å°å…¥ã‚’è¡Œã„ã¾ã—ãŸã€‚
ã¾ãŸã€Python ã‚’å‘¼ã³å‡ºã›ã‚‹ PyCall ã®å­˜åœ¨ã‚‚ä»Šå›åˆã‚ã¦çŸ¥ã£ãŸã®ã§ä»Šå¾Œä½¿ã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# å‚è€ƒ

https://www.rubydoc.info/gems/ruby-spacy/0.2.2
https://github.com/yohasebe/ruby-spacy
https://spacy.io/
https://ja.wikipedia.org/wiki/SpaCy
https://www.recruit.co.jp/newsroom/2019/0402_18331.html
https://peps.python.org/pep-0668/

ãã®ä»–å­¦ç¿’ã®å‚è€ƒã«ãªã£ãŸãƒšãƒ¼ã‚¸
https://qiita.com/ryoma_kochi/items/55d015ed9cb0a61b55a6
https://qiita.com/nikotan/items/47d8c73712a8d985c454
https://kantaro-cgi.com/blog/docker/dockerfile-build-by-bash.html

[^1]: ã¨ã„ã†èªè­˜ã§ã™ã€‚é–“é•ã£ã¦ãŸã‚‰æ•™ãˆã¦ãã ã•ã„ã€‚ã€‚ã€‚