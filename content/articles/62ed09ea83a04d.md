---
title: "ã€Rails API ã€‘after_action ã§ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ, ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼, ãƒ¬ã‚¹ãƒãƒ³ã‚¹ ã‚’å±•é–‹ã™ã‚‹"
emoji: "ğŸ°"
type: "tech"
topics:
  - "rails"
  - "ruby"
published: true
published_at: "2024-04-19 12:52"
---

Rails ã§ API ã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚
åˆ†æç”¨ã«ã€API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åŠ å·¥ã—ã¦ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã«è“„ç©ã•ã›ã‚‹å‡¦ç†ã«ã¤ã„ã¦å‚™å¿˜éŒ²ã¨ã—ã¦çŸ­ã„ã§ã™ãŒã¾ã¨ã‚ã¾ã™ã€‚

# çµè«–
- after_action ã§ request, params, response ã‚’åˆ‡ã‚Šå‡ºã—ã¦ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã«è“„ç©ã•ã›ã‚‹
- ä¸Šè¨˜å‡¦ç†ã‚’è¡Œã† BaseController ã‚’ä½œæˆã—ã€å„ç¨® Controller ã¯ã“ã‚Œã‚’ç¶™æ‰¿ã™ã‚‹

# after_action ã§ request, params, response ã‚’åˆ‡ã‚Šå‡ºã™
API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãªã©ã‚’ after_action å†…ã§åˆ©ç”¨ã™ã‚‹ã“ã¨è‡ªä½“ã¯é›£ã—ããªã„ã§ã™ã€‚
ã‚³ãƒ¼ãƒ‰ã«è½ã¨ã—è¾¼ã‚€ã¾ã§ã‚‚ãªã„ã§ã™ãŒã€`request`, `params`, `response` ã¨ã—ã¦å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```rb
auth = request.headers["Authorization"] # request åˆ©ç”¨ä¾‹
response_body = response.body

# ï½ï½ï½ï½ï¼ˆåŠ å·¥å‡¦ç†ï¼‰ï½ï½ï½ï½
# ãªã‚“ã‹ job ã¨ã‹ã§è“„ç©ã™ã‚‹
LogJob.perform_later(
  auth,
  params,
  response_body
)
```

# BaseController ã‚’ä½œæˆã—ã€å„ç¨® Controller ã¯ã“ã‚Œã‚’ç¶™æ‰¿ã™ã‚‹
ä¸Šè¨˜ã®å‡¦ç†ã‚’ after_action ã§è¡Œã† Controller ã‚’ä½œæˆã—ã€ã“ã‚Œã‚’ BaseController ã¨ã—ã¦å„ç¨® Controller ã«ç¶™æ‰¿ã•ã›ã¾ã™ã€‚

```rb
# base_controller.rb
class BaseController < ApplicationController
  
  after_action :put_log

  def put_log
    auth = request.headers["Authorization"] # request åˆ©ç”¨ä¾‹
    response_body = response.body
    
    # ï½ï½ï½ï½ï¼ˆåŠ å·¥å‡¦ç†ï¼‰ï½ï½ï½ï½
    # ãªã‚“ã‹ job ã¨ã‹ã§è“„ç©ã™ã‚‹
    LogJob.perform_later(
      auth,
      params,
      response_body
    )
  end
end
```

```
# posts_controller.rb
class PostsController < BaseController
    # å‡¦ç†
end
```

# ã•ã„ã”ã«
ä»Šå›ã® BaseController ã®ã‚ˆã†ãªä»•çµ„ã¿ã‚’ä½œã‚ŠãŸãã¦ after_action å†…ã§ response ãªã©ã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•ãŒã‚ã‹ã‚‰ãšã‚¹ãƒ‘ã‚²ãƒƒãƒ†ã‚£ã‚’ä½œã‚Šã‹ã‘ãŸã®ã§ã€å˜ç´”ãªã“ã¨ã§ã™ãŒå‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¾ã™

# å‚è€ƒ
https://api.rubyonrails.org/v7.1.3/classes/ActionDispatch/Response.html
https://api.rubyonrails.org/v7.1.3/classes/ActionDispatch/Request.html